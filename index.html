<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Safe Address Bar Race Detector</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 700px; }
    button { padding: 10px 18px; font-size: 16px; cursor: pointer; margin-top: 10px; }
    #result { margin-top: 20px; padding: 12px; border-radius: 6px; }
    .ok { background: #e3f8e5; border: 1px solid #4caf50; color: #256029; }
    .warn { background: #fff3cd; border: 1px solid #ff9800; color: #7a5a00; }
    .err { background: #fdecea; border: 1px solid #f44336; color: #8b1c13; }
    code { background: #f5f5f5; padding: 2px 4px; border-radius: 4px; }
  </style>
</head>
<body>

<h1>Safe Address Bar Race Detector</h1>
<p>
  Alat ini <strong>tidak melakukan spoofing</strong> apa pun. Ini hanya menguji:
</p>
<ul>
  <li>Setelah navigasi ke URL baru dimulai, apakah tab/window masih bisa di-<code>document.write()</code>?</li>
  <li>Jika masih bisa → ada <em>potensi</em> race-condition seperti PoC address bar desync.</li>
</ul>

<button onclick="runRaceTest()">Jalankan Tes</button>

<div id="result"></div>

<script>
function setResult(msg, cls) {
  const box = document.getElementById('result');
  box.className = cls;
  box.innerHTML = msg;
}

function runRaceTest() {
  setResult("Menjalankan tes... pastikan popup tidak diblokir.", "warn");

  // 1. Buka window baru (mulai sebagai about:blank)
  let win = window.open("https://www.google.com", "_blank");

  if (!win) {
    setResult("Popup diblokir oleh browser. Izinkan popup untuk situs ini lalu coba lagi.", "err");
    return;
  }

  // 2. Sedikit info di console
  console.log("[RaceDetector] New window opened as about:blank.");

  // 3. Setelah 50ms, mulai navigasi ke halaman lain (AMAN, hanya path lokal)
  setTimeout(() => {
    try {
      // Kalau kamu simpan file ini di localhost, ini akan mengarah ke /final.html di server yang sama.
      // Kalau di file://, ini akan mencoba membuka final.html di folder yang sama.
      win.location.href = "final.html";
      console.log("[RaceDetector] Navigation to final.html started.");
    } catch (e) {
      console.warn("[RaceDetector] Gagal memulai navigasi:", e);
    }
  }, 50);

  // 4. Setelah 120ms, coba document.write → lihat apakah masih bisa
  setTimeout(() => {
    if (win.closed) {
      setResult("Window test sudah tertutup sebelum tes selesai.", "err");
      return;
    }

    let injected = false;
    try {
      win.document.write(`
        <h1 style="color:red;">Race Detector Injection</h1>
        <p>Jika kamu melihat pesan ini <strong>setelah address bar menunjukkan final.html</strong>,
        berarti window masih writable setelah navigasi dimulai.</p>
        <p>Ini <em>indikasi potensi</em> race-condition seperti address bar desync
        pada kondisi tertentu (misalnya WebView lambat / error-state).</p>
      `);
      win.document.close();
      injected = true;
      console.log("[RaceDetector] document.write() setelah navigasi berhasil.");
    } catch (e) {
      console.log("[RaceDetector] document.write() setelah navigasi DIBLOKIR:", e);
      injected = false;
    }

    if (injected) {
      setResult(
        `
        <strong>HASIL:</strong> <br>
        ✅ Window masih <code>writable</code> setelah navigasi dimulai.<br><br>
        <strong>Interpretasi:</strong><br>
        - Browser/WebView kamu mengizinkan <code>document.write()</code> pada window yang sedang berpindah ke URL lain.<br>
        - Pada environment tertentu (misal in-app WebView lambat, jaringan pelan), ini
          <em>berpotensi</em> mendukung skenario desynchronization seperti PoC yang kamu ceritakan.<br><br>
        <em>Catatan:</em> Ini bukan eksploit, hanya indikator perilaku yang perlu dikaji lebih lanjut.
        `,
        "warn"
      );
    } else {
      setResult(
        `
        <strong>HASIL:</strong> <br>
        ✅ Browser/WebView tampaknya <strong>memblok</strong> <code>document.write()</code>
        setelah navigasi dimulai.<br><br>
        <strong>Interpretasi:</strong><br>
        - Ini perilaku yang lebih aman terhadap teknik address bar race/desync.<br>
        - Walau bukan jaminan 100% bebas bug, ini menunjukkan proteksi terhadap
          race-condition model seperti PoC kamu di Meta.<br><br>
        <em>Catatan:</em> Untuk hasil yang konsisten, coba juga di jaringan lambat atau WebView in-app yang berbeda.</em>
        `,
        "ok"
      );
    }
  }, 120); // jeda total: 50ms (mulai nav) + 70ms (race)
}
</script>

</body>
</html>

